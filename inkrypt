#!/usr/bin/env bash
# =============================================================================
# Inkrypt - Autonomous System & SSH Penetration Testing Framework
# CLI Entry Point
# =============================================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# =============================================================================
# Load .env file automatically
# =============================================================================
load_env() {
    if [[ -f "$SCRIPT_DIR/.env" ]]; then
        # Export all variables from .env (skip comments and empty lines)
        set -a
        source "$SCRIPT_DIR/.env"
        set +a
    fi
}

# Auto-create .env from .env.example on first run
setup_env() {
    if [[ ! -f "$SCRIPT_DIR/.env" ]]; then
        if [[ -f "$SCRIPT_DIR/.env.example" ]]; then
            cp "$SCRIPT_DIR/.env.example" "$SCRIPT_DIR/.env"
            echo -e "${YELLOW}[!] Created .env file from .env.example${NC}"
            echo -e "${YELLOW}[!] Edit .env and set your ANTHROPIC_API_KEY before running:${NC}"
            echo -e "${CYAN}    nano .env${NC}"
            echo ""
            exit 1
        fi
    fi
}

setup_env
load_env

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'
BOLD='\033[1m'

# =============================================================================
# Functions
# =============================================================================

show_banner() {
    echo -e "${CYAN}"
    cat << 'BANNER'

    ██╗███╗   ██╗██╗  ██╗██████╗ ██╗   ██╗██████╗ ████████╗
    ██║████╗  ██║██║ ██╔╝██╔══██╗╚██╗ ██╔╝██╔══██╗╚══██╔══╝
    ██║██╔██╗ ██║█████╔╝ ██████╔╝ ╚████╔╝ ██████╔╝   ██║
    ██║██║╚██╗██║██╔═██╗ ██╔══██╗  ╚██╔╝  ██╔═══╝    ██║
    ██║██║ ╚████║██║  ██╗██║  ██║   ██║   ██║        ██║
    ╚═╝╚═╝  ╚═══╝╚═╝  ╚═╝╚═╝  ╚═╝   ╚═╝   ╚═╝        ╚═╝

    Autonomous System & SSH Penetration Testing Framework
    =====================================================

BANNER
    echo -e "${NC}"
}

show_help() {
    show_banner
    echo -e "${BOLD}USAGE:${NC}"
    echo -e "  ./inkrypt ${GREEN}start${NC} TARGET=<ip|hostname> [OPTIONS]"
    echo -e "  ./inkrypt ${GREEN}logs${NC}  ID=<workflow-id>"
    echo -e "  ./inkrypt ${GREEN}query${NC} ID=<workflow-id>"
    echo -e "  ./inkrypt ${GREEN}stop${NC}  [CLEAN=true]"
    echo -e "  ./inkrypt ${GREEN}help${NC}"
    echo ""
    echo -e "${BOLD}OPTIONS:${NC}"
    echo -e "  ${YELLOW}TARGET${NC}=<ip|hostname>     Target system IP or hostname (required)"
    echo -e "  ${YELLOW}SSH_USER${NC}=<user>          SSH username for authenticated testing"
    echo -e "  ${YELLOW}SSH_KEY${NC}=<path>           Path to SSH private key"
    echo -e "  ${YELLOW}SSH_PASS${NC}=<password>      SSH password (use with caution)"
    echo -e "  ${YELLOW}SSH_PORT${NC}=<port>          SSH port (default: 22)"
    echo -e "  ${YELLOW}CONFIG${NC}=<path>            YAML configuration file path"
    echo -e "  ${YELLOW}OUTPUT${NC}=<path>            Custom output directory"
    echo -e "  ${YELLOW}SCOPE${NC}=<cidr>             Network scope for scanning (e.g., 192.168.1.0/24)"
    echo -e "  ${YELLOW}PIPELINE_TESTING${NC}=true    Fast iteration mode (minimal prompts)"
    echo -e "  ${YELLOW}REBUILD${NC}=true             Force Docker rebuild (--no-cache)"
    echo ""
    echo -e "${BOLD}EXAMPLES:${NC}"
    echo -e "  ${CYAN}# Basic system scan${NC}"
    echo -e "  ./inkrypt start TARGET=192.168.1.100"
    echo ""
    echo -e "  ${CYAN}# SSH authenticated pentest${NC}"
    echo -e "  ./inkrypt start TARGET=10.0.0.5 SSH_USER=admin SSH_KEY=~/.ssh/id_rsa"
    echo ""
    echo -e "  ${CYAN}# Network scope scan with config${NC}"
    echo -e "  ./inkrypt start TARGET=10.0.0.1 SCOPE=10.0.0.0/24 CONFIG=configs/internal.yaml"
    echo ""
    echo -e "  ${CYAN}# Query running pentest${NC}"
    echo -e "  ./inkrypt query ID=inkrypt-abc123"
    echo ""
    echo -e "${BOLD}SETUP:${NC}"
    echo -e "  ${CYAN}1.${NC} Edit ${YELLOW}.env${NC} and set your ${YELLOW}ANTHROPIC_API_KEY${NC}"
    echo -e "  ${CYAN}2.${NC} Run ${GREEN}./inkrypt start TARGET=<ip>${NC}"
    echo ""
    echo -e "${BOLD}SECURITY TOOLS INCLUDED:${NC}"
    echo -e "  Metasploit, nmap, masscan, hydra, medusa, hashcat, john, ssh-audit,"
    echo -e "  nuclei, nikto, sqlmap, gobuster, enum4linux, crackmapexec, impacket,"
    echo -e "  LinPEAS, LinEnum, lynis, testssl.sh, searchsploit, and 20+ more"
    echo ""
}

validate_credentials() {
    if [[ -z "${ANTHROPIC_API_KEY:-}" ]] && [[ -z "${CLAUDE_CODE_OAUTH_TOKEN:-}" ]]; then
        echo -e "${RED}ERROR: ANTHROPIC_API_KEY is not set${NC}"
        echo -e ""
        echo -e "${YELLOW}Set your API key in the .env file:${NC}"
        echo -e "${CYAN}    1. Open .env:   nano .env${NC}"
        echo -e "${CYAN}    2. Replace the placeholder with your actual key:${NC}"
        echo -e "${CYAN}       ANTHROPIC_API_KEY=sk-ant-your-actual-key-here${NC}"
        echo -e "${CYAN}    3. Save and re-run ./inkrypt start ...${NC}"
        echo ""
        if [[ ! -f "$SCRIPT_DIR/.env" ]]; then
            echo -e "${YELLOW}No .env file found. Creating from template...${NC}"
            cp "$SCRIPT_DIR/.env.example" "$SCRIPT_DIR/.env" 2>/dev/null || true
            echo -e "${GREEN}Created .env - edit it now: nano .env${NC}"
        fi
        exit 1
    fi

    # Check if still using placeholder
    if [[ "${ANTHROPIC_API_KEY:-}" == "sk-ant-your-key-here" ]]; then
        echo -e "${RED}ERROR: ANTHROPIC_API_KEY still has the placeholder value${NC}"
        echo -e "${YELLOW}Edit .env and replace with your actual API key:${NC}"
        echo -e "${CYAN}    nano .env${NC}"
        exit 1
    fi
}

parse_args() {
    local command="${1:-help}"
    shift || true

    for arg in "$@"; do
        case "$arg" in
            TARGET=*)   export INKRYPT_TARGET="${arg#TARGET=}" ;;
            SSH_USER=*) export INKRYPT_SSH_USER="${arg#SSH_USER=}" ;;
            SSH_KEY=*)  export INKRYPT_SSH_KEY="${arg#SSH_KEY=}" ;;
            SSH_PASS=*) export INKRYPT_SSH_PASS="${arg#SSH_PASS=}" ;;
            SSH_PORT=*) export INKRYPT_SSH_PORT="${arg#SSH_PORT=}" ;;
            CONFIG=*)   export INKRYPT_CONFIG="${arg#CONFIG=}" ;;
            OUTPUT=*)   export INKRYPT_OUTPUT="${arg#OUTPUT=}" ;;
            SCOPE=*)    export INKRYPT_SCOPE="${arg#SCOPE=}" ;;
            ID=*)       export INKRYPT_WORKFLOW_ID="${arg#ID=}" ;;
            PIPELINE_TESTING=*) export INKRYPT_PIPELINE_TESTING="${arg#PIPELINE_TESTING=}" ;;
            REBUILD=*)  export INKRYPT_REBUILD="${arg#REBUILD=}" ;;
            CLEAN=*)    export INKRYPT_CLEAN="${arg#CLEAN=}" ;;
            *)          echo -e "${RED}Unknown argument: $arg${NC}"; exit 1 ;;
        esac
    done

    echo "$command"
}

ensure_containers() {
    local build_flags=""
    if [[ "${INKRYPT_REBUILD:-false}" == "true" ]]; then
        build_flags="--build --no-cache"
    fi

    echo -e "${BLUE}[*] Ensuring Temporal and Worker containers are running...${NC}"
    docker compose up -d $build_flags

    echo -e "${BLUE}[*] Waiting for Temporal to be healthy...${NC}"
    local retries=0
    while ! docker compose exec -T temporal temporal workflow list --namespace default &>/dev/null; do
        retries=$((retries + 1))
        if [[ $retries -ge 30 ]]; then
            echo -e "${RED}ERROR: Temporal server failed to start${NC}"
            exit 1
        fi
        sleep 2
    done
    echo -e "${GREEN}[+] Temporal server is healthy${NC}"
}

cmd_start() {
    if [[ -z "${INKRYPT_TARGET:-}" ]]; then
        echo -e "${RED}ERROR: TARGET is required${NC}"
        echo -e "${YELLOW}Usage: ./inkrypt start TARGET=<ip|hostname>${NC}"
        exit 1
    fi

    validate_credentials
    show_banner

    echo -e "${GREEN}[+] Target: ${BOLD}${INKRYPT_TARGET}${NC}"
    [[ -n "${INKRYPT_SSH_USER:-}" ]] && echo -e "${GREEN}[+] SSH User: ${INKRYPT_SSH_USER}${NC}"
    [[ -n "${INKRYPT_SSH_PORT:-}" ]] && echo -e "${GREEN}[+] SSH Port: ${INKRYPT_SSH_PORT}${NC}"
    [[ -n "${INKRYPT_SCOPE:-}" ]]    && echo -e "${GREEN}[+] Scope: ${INKRYPT_SCOPE}${NC}"
    [[ -n "${INKRYPT_CONFIG:-}" ]]   && echo -e "${GREEN}[+] Config: ${INKRYPT_CONFIG}${NC}"
    echo ""

    ensure_containers

    # Build client args
    local client_args=("${INKRYPT_TARGET}")
    [[ -n "${INKRYPT_SSH_USER:-}" ]]  && client_args+=("--ssh-user" "${INKRYPT_SSH_USER}")
    [[ -n "${INKRYPT_SSH_KEY:-}" ]]   && client_args+=("--ssh-key" "${INKRYPT_SSH_KEY}")
    [[ -n "${INKRYPT_SSH_PASS:-}" ]]  && client_args+=("--ssh-pass" "${INKRYPT_SSH_PASS}")
    [[ -n "${INKRYPT_SSH_PORT:-}" ]]  && client_args+=("--ssh-port" "${INKRYPT_SSH_PORT}")
    [[ -n "${INKRYPT_CONFIG:-}" ]]    && client_args+=("--config" "${INKRYPT_CONFIG}")
    [[ -n "${INKRYPT_OUTPUT:-}" ]]    && client_args+=("--output" "${INKRYPT_OUTPUT}")
    [[ -n "${INKRYPT_SCOPE:-}" ]]     && client_args+=("--scope" "${INKRYPT_SCOPE}")
    [[ "${INKRYPT_PIPELINE_TESTING:-false}" == "true" ]] && client_args+=("--pipeline-testing")

    echo -e "${BLUE}[*] Submitting pentest workflow...${NC}"
    docker compose exec -T \
        -e ANTHROPIC_API_KEY="${ANTHROPIC_API_KEY:-}" \
        -e CLAUDE_CODE_OAUTH_TOKEN="${CLAUDE_CODE_OAUTH_TOKEN:-}" \
        worker node dist/temporal/client.js "${client_args[@]}"
}

cmd_query() {
    if [[ -z "${INKRYPT_WORKFLOW_ID:-}" ]]; then
        echo -e "${RED}ERROR: ID is required${NC}"
        echo -e "${YELLOW}Usage: ./inkrypt query ID=<workflow-id>${NC}"
        exit 1
    fi

    docker compose exec -T worker node dist/temporal/query.js "${INKRYPT_WORKFLOW_ID}"
}

cmd_logs() {
    if [[ -z "${INKRYPT_WORKFLOW_ID:-}" ]]; then
        echo -e "${RED}ERROR: ID is required${NC}"
        echo -e "${YELLOW}Usage: ./inkrypt logs ID=<workflow-id>${NC}"
        exit 1
    fi

    docker compose logs -f worker 2>&1 | grep -i "${INKRYPT_WORKFLOW_ID}"
}

cmd_stop() {
    echo -e "${YELLOW}[*] Stopping Inkrypt containers...${NC}"
    if [[ "${INKRYPT_CLEAN:-false}" == "true" ]]; then
        docker compose down -v --remove-orphans
        echo -e "${GREEN}[+] Containers stopped and volumes removed${NC}"
    else
        docker compose down
        echo -e "${GREEN}[+] Containers stopped (data preserved)${NC}"
    fi
}

# =============================================================================
# Main
# =============================================================================

COMMAND=$(parse_args "$@")

case "$COMMAND" in
    start) cmd_start ;;
    query) cmd_query ;;
    logs)  cmd_logs ;;
    stop)  cmd_stop ;;
    help)  show_help ;;
    *)
        echo -e "${RED}Unknown command: $COMMAND${NC}"
        show_help
        exit 1
        ;;
esac
